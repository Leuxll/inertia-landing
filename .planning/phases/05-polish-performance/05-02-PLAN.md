---
phase: 05-polish-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/scroll-reveal.tsx
  - src/components/ui/geometric-accent.tsx
  - src/components/ui/feature-section.tsx
  - src/components/providers/lenis-provider.tsx
  - src/app/page.tsx
  - src/lib/animations.ts
autonomous: true

must_haves:
  truths:
    - "With `prefers-reduced-motion: reduce` set in OS, all scroll animations (fade-ups, stagger reveals) are skipped and content is immediately visible"
    - "With reduced-motion, parallax effects are disabled (no moving background circles or phone frame drift)"
    - "With reduced-motion, button hover transitions are instant (no scale animation)"
    - "With reduced-motion, Lenis smooth scroll is disabled (native browser scroll instead)"
    - "Hero image area renders without Lighthouse CLS warnings (stable layout from paint)"
    - "Page achieves 90+ Lighthouse performance score on desktop"
  artifacts:
    - path: "src/components/ui/scroll-reveal.tsx"
      provides: "Reduced-motion gated scroll animations"
      contains: "useReducedMotion|reducedMotion"
    - path: "src/components/ui/geometric-accent.tsx"
      provides: "Reduced-motion disabled parallax"
      contains: "useReducedMotion"
    - path: "src/components/providers/lenis-provider.tsx"
      provides: "Conditional Lenis (disabled under reduced-motion)"
      contains: "useReducedMotion|autoRaf.*false|destroy"
    - path: "src/app/page.tsx"
      provides: "Hero section performance (no layout shift)"
  key_links:
    - from: "src/components/ui/scroll-reveal.tsx"
      to: "Framer Motion useReducedMotion hook"
      via: "import { useReducedMotion } from 'motion/react'"
      pattern: "useReducedMotion"
    - from: "src/components/providers/lenis-provider.tsx"
      to: "prefers-reduced-motion media query"
      via: "useReducedMotion from motion/react OR window.matchMedia"
      pattern: "reducedMotion|matchMedia.*reduced"
---

<objective>
Gate all animations behind `prefers-reduced-motion` and run a Lighthouse optimization pass to achieve 90+ desktop score — completing the accessibility and performance requirements.

Purpose: Reduced-motion is a legally significant accessibility setting; many users with vestibular disorders depend on it. Performance at 90+ keeps the page fast for users on slower connections.
Output: Updated ScrollReveal, GeometricAccent, FeatureSection, LenisProvider with reduced-motion support; hero page with any quick Lighthouse wins applied.
</objective>

<execution_context>
@/Users/yuefunglee/.config/Claude/get-shit-done/workflows/execute-plan.md
@/Users/yuefunglee/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-performance/05-CONTEXT.md

Relevant source files (read before editing):
@src/components/ui/scroll-reveal.tsx
@src/components/ui/geometric-accent.tsx
@src/components/ui/feature-section.tsx
@src/components/ui/button.tsx
@src/components/providers/lenis-provider.tsx
@src/app/page.tsx
@src/app/layout.tsx
@src/lib/animations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduced-motion support across all animated components</name>
  <files>
    src/components/ui/scroll-reveal.tsx
    src/components/ui/geometric-accent.tsx
    src/components/ui/feature-section.tsx
    src/components/ui/button.tsx
    src/components/providers/lenis-provider.tsx
    src/lib/animations.ts
  </files>
  <action>
The strategy: `useReducedMotion()` from `motion/react` returns `true` when the OS `prefers-reduced-motion: reduce` media query is active. When true, skip all animation — content appears immediately visible.

**1. animations.ts — reduced-motion variants:**

Add reduced-motion-safe variants that show content instantly:
```ts
// Instant-visible variant for reduced-motion contexts
export const noMotion = {
  hidden: { opacity: 1, y: 0, x: 0 },
  visible: { opacity: 1, y: 0, x: 0 },
};

export const noMotionStagger = {
  hidden: {},
  visible: {},
};
```

**2. ScrollReveal — gate all animation:**

```tsx
"use client";
import { motion, useReducedMotion } from "motion/react";
import { fadeUp, staggerContainer, noMotion, noMotionStagger } from "@/lib/animations";

export function ScrollReveal({ children, className, variant = "fadeUp", delay = 0 }) {
  const prefersReducedMotion = useReducedMotion();
  
  // When reduced-motion: use instant-visible variants, no viewport gating needed
  const variants = prefersReducedMotion
    ? (variant === "stagger" ? noMotionStagger : noMotion)
    : (variant === "stagger" ? staggerContainer : fadeUp);

  return (
    <motion.div
      initial="hidden"
      whileInView="visible"
      viewport={{ once: true, margin: "-100px" }}
      variants={variants}
      className={className}
      style={delay && !prefersReducedMotion ? { transitionDelay: `${delay}s` } : undefined}
    >
      {children}
    </motion.div>
  );
}
```

**3. GeometricAccent — disable parallax and rotation under reduced-motion:**

In `geometric-accent.tsx`:
1. Import `useReducedMotion` from `motion/react`.
2. When `prefersReducedMotion` is true:
   - Set `y1 = useTransform(scrollYProgress, [0, 1], [0, 0])` — no parallax movement (or conditionally skip the `useScroll` transforms entirely using a static `style={{}}`)
   - Remove the `animate={{ rotate: 360 }}` by using `animate={prefersReducedMotion ? {} : { rotate: 360 }}`

**Important Framer Motion hook rule:** `useScroll` and `useTransform` are hooks — they MUST be called unconditionally (no early returns before hooks). Always call them, but conditionally use their values:

```tsx
const { scrollYProgress } = useScroll({ offset: ["start start", "end start"] });
const y1Raw = useTransform(scrollYProgress, [0, 1], [0, -60]);
const y2Raw = useTransform(scrollYProgress, [0, 1], [0, -30]);
const prefersReducedMotion = useReducedMotion();

// Use static 0 when reduced-motion
const y1 = prefersReducedMotion ? 0 : y1Raw;
const y2 = prefersReducedMotion ? 0 : y2Raw;
```

Note: Framer Motion's `useReducedMotion` returns `null` on SSR (server). Handle: `const reduced = prefersReducedMotion ?? false`.

**4. FeatureSection — disable phone frame parallax:**

Same pattern as GeometricAccent: call `useScroll`/`useTransform` unconditionally, apply `const phoneY = reduced ? 0 : phoneYRaw`.

**5. Button — instant transitions under reduced-motion:**

In `button.tsx`:
```tsx
const prefersReducedMotion = useReducedMotion() ?? false;
const hoverAnimation = prefersReducedMotion
  ? {}
  : (variant === 'primary'
      ? { scale: 1.02, boxShadow: "0 0 20px rgba(255,255,255,0.15)" }
      : { scale: 1.02, opacity: 0.9 });
const tapAnimation = prefersReducedMotion ? {} : { scale: 0.98 };
```
Apply `whileHover={hoverAnimation}` and `whileTap={tapAnimation}`.

**6. LenisProvider — disable smooth scroll under reduced-motion:**

Lenis smooth scrolling can cause vestibular issues. Disable it when reduced-motion is preferred.

```tsx
"use client";
import { useEffect, useRef } from "react";
import Lenis from "lenis";
import { ReactLenis } from "lenis/react";
```

Switch to manual Lenis control:
```tsx
export function LenisProvider({ children }) {
  const prefersReducedMotion = 
    typeof window !== "undefined" 
      ? window.matchMedia("(prefers-reduced-motion: reduce)").matches 
      : false;

  if (prefersReducedMotion) {
    // Return children directly — native scroll
    return <>{children}</>;
  }

  return (
    <ReactLenis root options={{ lerp: 0.1, duration: 1.2, smoothWheel: true, syncTouch: false }}>
      {children}
    </ReactLenis>
  );
}
```

Note: This check runs on client. Use `useState` + `useEffect` to avoid hydration mismatch:
```tsx
"use client";
import { useState, useEffect } from "react";
import { ReactLenis } from "lenis/react";

export function LenisProvider({ children }) {
  const [reduced, setReduced] = useState(false);

  useEffect(() => {
    const mq = window.matchMedia("(prefers-reduced-motion: reduce)");
    setReduced(mq.matches);
    const handler = (e: MediaQueryListEvent) => setReduced(e.matches);
    mq.addEventListener("change", handler);
    return () => mq.removeEventListener("change", handler);
  }, []);

  if (reduced) return <>{children}</>;

  return (
    <ReactLenis root options={{ lerp: 0.1, duration: 1.2, smoothWheel: true, syncTouch: false }}>
      {children}
    </ReactLenis>
  );
}
```
  </action>
  <verify>
    1. `npm run build` — TypeScript clean, no errors
    2. In Chrome DevTools: Rendering panel → check "Emulate CSS media feature prefers-reduced-motion: reduce"
    3. Reload page: all content visible immediately (no fade-up animations)
    4. Scroll: background circles are static (no rotation, no parallax)
    5. Hover button: no scale animation
    6. Scroll: native browser scroll (no smooth Lenis lerp)
    7. Turn off emulation: all animations return to normal
  </verify>
  <done>
    All animations, parallax, and smooth scroll are completely disabled under prefers-reduced-motion. Content is immediately accessible without motion. Normal behavior returns when reduced-motion is off. RESP-02 satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lighthouse performance optimization pass</name>
  <files>
    src/app/page.tsx
    src/app/layout.tsx
    src/components/ui/phone-frame.tsx
  </files>
  <action>
Run a Lighthouse desktop audit and fix the most impactful issues. Target: 90+ performance score.

**Step 1: Build and audit baseline**

```bash
npm run build
```

Check output for:
- Bundle size warnings (anything over 244KB first load JS is flagged by Next.js)
- Any "Large page data" warnings

**Step 2: Hero above-fold performance**

The hero section must paint fast. Key fixes:

In `src/app/page.tsx`, the hero uses a `GeometricAccent` (SVG/CSS — fast, no concern) and text. No images in the hero — this is already optimal.

**Step 3: Phone frame images**

Each feature section has a `<PhoneFrame src="/screenshots/placeholder-*.svg" />`. These are SVG placeholders — already optimal (no JPEG/PNG to optimize).

However, the `priority` prop should be added to the first visible phone frame (habit-tracking-section, since it's above the fold). Update `phone-frame.tsx` to accept a `priority` prop:

```tsx
interface PhoneFrameProps {
  src: string;
  alt: string;
  className?: string;
  priority?: boolean; // Add this
}

// Pass it to <Image>:
<Image
  src={src}
  alt={alt}
  fill
  priority={priority}
  className="object-cover"
  sizes="(max-width: 768px) 260px, (max-width: 1024px) 280px, 300px"
/>
```

Then in `src/components/features/habit-tracking-section.tsx`, add `priority` to the first feature section's PhoneFrame (via FeatureSection's `screenshotPriority` prop, OR directly). The simplest approach: add a `screenshotPriority?: boolean` prop to `FeatureSection` and pass it through to `PhoneFrame`.

**Step 4: Layout Cumulative Shift (CLS)**

The nav appears after scroll — this is intentional and shouldn't cause CLS since it's `fixed` positioning.

The `LenisProvider` hydration switch (from plan Task 1) could momentarily cause a layout shift. Mitigate by starting with `reduced=false` default (assumes motion OK, then corrects if needed — visually fine since correction happens before first frame on most systems).

**Step 5: Font display**

Already using `display: "swap"` for both fonts — ✓ optimal.

**Step 6: Metadata and viewport**

Check `src/app/layout.tsx`:
- Verify `viewport` meta is present (Next.js App Router adds it automatically via metadata export — add if missing)
- Add explicit viewport metadata if not present:
```tsx
export const viewport = {
  width: 'device-width',
  initialScale: 1,
};
```
This prevents Lighthouse from flagging "Does not have a <meta name="viewport"> tag".

**Step 7: Run production build + Lighthouse**

```bash
npm run build && npx next start &
# Wait for server, then:
# Use Chrome DevTools Lighthouse panel (Desktop mode)
# OR: npx lighthouse http://localhost:3000 --preset=desktop --output=json 2>&1 | grep '"score"' | head -5
```

If Lighthouse score is below 90, identify the top opportunities from the report and fix them. Common issues on this stack:
- Unused JavaScript: Check if `motion/react` is importing more than needed — it's tree-shaken, should be fine
- Render-blocking resources: Fonts already use `display:swap` — ✓
- Image sizing: SVG placeholders have no sizing overhead — ✓

**Step 8: Add `@vercel/analytics` if not present (skip — adds JS weight)**

Do NOT add analytics — it adds unnecessary JS for a Lighthouse run.

**What to document in SUMMARY:** Record the actual Lighthouse score achieved, which specific fixes were applied, and any remaining issues for future phases.
  </action>
  <verify>
    1. `npm run build` — clean, no size warnings
    2. `npm run dev` — page loads and displays correctly
    3. In Chrome: DevTools → Lighthouse → Desktop → Generate report
    4. Performance score ≥ 90
    5. No new TypeScript errors introduced
  </verify>
  <done>
    Page achieves Lighthouse 90+ desktop performance. Priority image prop applied to first feature phone frame. Viewport metadata confirmed. INFRA-03 satisfied. Build is clean.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `npm run build` — clean TypeScript, no bundle warnings
2. Reduced-motion test: Chrome DevTools → Rendering → "prefers-reduced-motion: reduce" → reload → content visible immediately, no motion
3. Normal mode: all parallax and micro-interactions work from Plan 01
4. Lighthouse desktop audit: ≥ 90 performance score
5. Check WCAG: no contrast regressions from any new elements added
</verification>

<success_criteria>
- RESP-02 satisfied: prefers-reduced-motion gates all animations, parallax, and smooth scroll
- INFRA-03 satisfied: Lighthouse desktop ≥ 90
- No hydration mismatches in browser console
- TypeScript build passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-performance/05-02-SUMMARY.md` following the summary template.
</output>
