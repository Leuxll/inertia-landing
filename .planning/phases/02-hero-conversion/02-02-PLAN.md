---
phase: 02-hero-conversion
plan: 02
type: execute
wave: 1
depends_on: ["01-03"]
files_modified:
  - src/app/api/waitlist/route.ts
  - src/lib/email/welcome-template.ts
  - src/lib/rate-limit.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/waitlist accepts JSON { email }, validates format, stores via Resend contact, and returns 200 with { success: true }"
    - "Invalid email returns 400 with { error: message }"
    - "Rate limiting prevents more than 3 submissions per IP per hour, returning 429 on excess"
    - "Successful signup triggers a branded welcome email via Resend with dark aesthetic and philosophical tone"
    - "Welcome email has dark background, minimal layout, no images — feels like a Co-Star message"
    - "API route handles Resend SDK errors gracefully and returns 500 with { error: message }"
    - "GET /api/waitlist returns { count: number } for the waitlist counter (02-03 will consume this)"
  artifacts:
    - path: "src/app/api/waitlist/route.ts"
      provides: "POST handler for email signup, GET handler for waitlist count"
      contains: "Resend"
    - path: "src/lib/email/welcome-template.ts"
      provides: "HTML welcome email template with Momentum branding"
      contains: "html"
    - path: "src/lib/rate-limit.ts"
      provides: "In-memory rate limiter for API routes"
      contains: "rateLimit"
  key_links:
    - from: "src/app/api/waitlist/route.ts"
      to: "src/lib/email/welcome-template.ts"
      via: "Imports welcome email HTML for Resend send call"
      pattern: "import.*welcome"
    - from: "src/app/api/waitlist/route.ts"
      to: "src/lib/rate-limit.ts"
      via: "Applies rate limiting before processing signup"
      pattern: "import.*rate-limit"
---

<objective>
Build the email capture backend: a Next.js API route that receives waitlist signups, validates them, rate-limits by IP, stores contacts in Resend, and sends a branded welcome email.

Purpose: The hero CTA (02-01) submits to this endpoint. Without it, the email form has nowhere to POST. This is the conversion pipeline — every signup collected here is a future App Store download on launch day.
Output: A working /api/waitlist POST endpoint that validates email, rate-limits, creates a Resend contact, sends a welcome email, and returns success/error JSON. Plus a GET endpoint returning subscriber count for the waitlist counter (02-03).
</objective>

<execution_context>
@/Users/yuefunglee/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/yuefunglee/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-hero-conversion/02-CONTEXT.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Resend SDK and build rate limiter + welcome email template</name>
  <files>
    package.json (modified by pnpm add)
    src/lib/rate-limit.ts
    src/lib/email/welcome-template.ts
  </files>
  <action>
    **1. Install Resend SDK:**
    ```bash
    pnpm add resend
    ```
    No need for react-email or @react-email/components — the welcome email is simple enough to use inline HTML (CONTEXT.md: "dark background matching site aesthetic, short philosophical message, no images").

    **2. Rate limiter** (`src/lib/rate-limit.ts`):

    Build a simple in-memory rate limiter. This is a Vercel serverless function so in-memory works for basic protection (each cold start resets, which is acceptable for a landing page with low traffic).

    Implementation:
    - Export a `rateLimit` function that takes: `{ key: string, limit: number, windowMs: number }`
    - Uses a `Map<string, { count: number, resetTime: number }>` stored at module scope
    - On each call: check if key exists and hasn't expired, increment count
    - Returns `{ success: boolean, remaining: number }`
    - Clean up expired entries periodically (e.g., on each call, remove entries past resetTime)
    - Default config for waitlist: 3 requests per IP per 60 minutes (3600000ms)

    **3. Welcome email template** (`src/lib/email/welcome-template.ts`):

    Export a function `getWelcomeEmailHtml(email: string): string` that returns an HTML string for the welcome email.

    **Design — LOCKED decisions from CONTEXT.md:**
    - Dark background matching site aesthetic (#0a0a0a or close — note: some email clients won't render this, so use inline styles with fallback)
    - Short philosophical message — NO images, NO logos, NO complex layout
    - Tone: "You're on the list. We'll be in touch." — feels like receiving a message from Co-Star
    - Minimal, dark, philosophical

    **Email HTML structure:**
    ```html
    <!DOCTYPE html>
    <html>
    <head><meta charset="utf-8"></head>
    <body style="background-color: #0a0a0a; color: #f4f4f0; font-family: Georgia, 'Times New Roman', serif; padding: 48px 24px; margin: 0;">
      <div style="max-width: 480px; margin: 0 auto;">
        <!-- Small uppercase label -->
        <p style="font-family: -apple-system, sans-serif; font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; color: #a1a1a1; margin-bottom: 32px;">
          MOMENTUM
        </p>

        <!-- Main message — short, philosophical -->
        <h1 style="font-size: 24px; font-weight: 400; line-height: 1.4; margin-bottom: 24px;">
          You're on the list.
        </h1>

        <p style="font-size: 16px; line-height: 1.6; color: #a1a1a1; margin-bottom: 32px;">
          [1-2 sentences — Claude writes the copy. Philosophical, understated.
           Something like: "We're building something different — a habit tracker
           that tells the truth. When it's ready, you'll be the first to know."]
        </p>

        <!-- Sign-off -->
        <p style="font-size: 14px; color: #a1a1a1; border-top: 1px solid rgba(244,244,240,0.1); padding-top: 24px; margin-top: 48px;">
          Momentum &mdash; The Anti-Subscription Habit Tracker
        </p>
      </div>
    </body>
    </html>
    ```

    **Claude writes the actual copy** — the above is structural guidance. The email should feel like a quiet, confident confirmation. Not excited, not salesy. Philosophical.

    **Email subject line:** "You're in." — short, confident (Claude may adjust slightly).

    Also export the subject line: `export const WELCOME_EMAIL_SUBJECT = "You're in."`
  </action>
  <verify>
    - `pnpm install` succeeds with resend in dependencies
    - rate-limit.ts exports a rateLimit function with the specified interface
    - Rate limiter correctly limits: 4th call with same key within window returns { success: false }
    - welcome-template.ts exports getWelcomeEmailHtml function and WELCOME_EMAIL_SUBJECT
    - Email HTML uses inline styles (no external CSS — email clients strip <style> blocks)
    - Email matches design: dark bg, light text, minimal, philosophical tone
    - `pnpm build` succeeds
  </verify>
  <done>Resend SDK installed, rate limiter built with in-memory Map, welcome email template with dark branded design</done>
</task>

<task type="auto">
  <name>Task 2: Build the /api/waitlist API route (POST + GET)</name>
  <files>
    src/app/api/waitlist/route.ts
  </files>
  <action>
    Build the Next.js App Router API route that handles waitlist signups.

    **Environment variable:** The route needs `RESEND_API_KEY` (server-only, no NEXT_PUBLIC_ prefix). Add a check at the top that returns 500 if not configured.

    **Also needs:** `RESEND_AUDIENCE_ID` — Resend uses "audiences" to manage contact lists. The waitlist is stored as a Resend audience.

    **POST /api/waitlist — signup handler:**

    ```typescript
    import { NextRequest, NextResponse } from "next/server";
    import { Resend } from "resend";
    import { rateLimit } from "@/lib/rate-limit";
    import { getWelcomeEmailHtml, WELCOME_EMAIL_SUBJECT } from "@/lib/email/welcome-template";
    ```

    1. **Parse request body:** Extract `{ email }` from JSON body. If missing, return 400.

    2. **Validate email format:**
       - Basic regex validation (standard email pattern)
       - If invalid, return 400 with `{ error: "Please enter a valid email address" }`

    3. **Rate limit by IP:**
       - Extract IP from `request.headers.get("x-forwarded-for")` (Vercel provides this) or fallback to "unknown"
       - Call `rateLimit({ key: ip, limit: 3, windowMs: 3600000 })` (3 per hour)
       - If rate limited, return 429 with `{ error: "Too many requests. Please try again later." }`

    4. **Create Resend contact:**
       - Initialize `new Resend(process.env.RESEND_API_KEY)`
       - Call `resend.contacts.create({ email, audienceId: process.env.RESEND_AUDIENCE_ID! })`
       - This stores the email in the Resend audience for future blast
       - If contact already exists, Resend returns an error — handle gracefully by treating it as success (user gets a "you're in" message either way, but don't send duplicate welcome emails)
       - Check error message for "already exists" pattern

    5. **Send welcome email:**
       - Only send if the contact was newly created (not a duplicate)
       - Call `resend.emails.send({ from: "Momentum <hello@[domain]>", to: email, subject: WELCOME_EMAIL_SUBJECT, html: getWelcomeEmailHtml(email) })`
       - **from address:** Use `onboarding@resend.dev` as temporary sender until domain is verified (Resend provides this for testing). OR use an env var `RESEND_FROM_EMAIL` so it can be updated when domain is ready.
       - If email send fails, log the error but still return success (contact was created, that's the important part)

    6. **Return success:** `{ success: true }` with status 200

    7. **Error handling:**
       - Wrap everything in try/catch
       - On unexpected errors, return 500 with `{ error: "Something went wrong. Please try again." }`
       - Log the actual error with console.error for debugging

    **GET /api/waitlist — waitlist count:**

    - Call `resend.contacts.list({ audienceId: process.env.RESEND_AUDIENCE_ID! })`
    - Return `{ count: contacts.data?.data?.length ?? 0 }`
    - This is used by the waitlist counter in 02-03
    - Light caching: set `Cache-Control: s-maxage=60` header so Vercel edge caches for 1 minute
    - If Resend API fails, return `{ count: 0 }` gracefully

    **Environment variables needed (document in the plan for executor):**
    - `RESEND_API_KEY` — from Resend dashboard
    - `RESEND_AUDIENCE_ID` — create an audience called "Waitlist" in Resend dashboard
    - `RESEND_FROM_EMAIL` — sender email (default: `onboarding@resend.dev` for testing)

    **Add to .env.local (create if doesn't exist) with placeholder values:**
    ```
    RESEND_API_KEY=re_your_api_key_here
    RESEND_AUDIENCE_ID=your_audience_id_here
    RESEND_FROM_EMAIL=onboarding@resend.dev
    ```

    The route file should NOT import any client-side code or React — it's a pure server route.
  </action>
  <verify>
    - `pnpm build` succeeds
    - Route file exists at src/app/api/waitlist/route.ts
    - POST handler validates email, rate-limits, creates Resend contact, sends welcome email
    - GET handler returns { count: number }
    - 400 returned for missing/invalid email
    - 429 returned when rate limit exceeded
    - 500 returned with generic message on unexpected errors
    - Duplicate emails handled gracefully (no error to user)
    - Welcome email only sent for new contacts (not duplicates)
    - .env.local has placeholder values for RESEND_API_KEY, RESEND_AUDIENCE_ID, RESEND_FROM_EMAIL
    - No client-side imports in the route file
  </verify>
  <done>Waitlist API route handles POST (signup with validation, rate limiting, Resend contact creation, welcome email) and GET (subscriber count) with graceful error handling</done>
</task>

</tasks>

<verification>
Verify against Phase 2 requirements covered by this plan:

1. **INFRA-02**: Email capture uses Resend via Next.js API route with validation and rate limiting — POST /api/waitlist
2. **HERO-07**: Welcome email with Momentum branding — sent via Resend on successful signup
3. **HERO-02** (backend): Waitlist signup endpoint exists and works — test with curl:
   ```bash
   curl -X POST http://localhost:3000/api/waitlist \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com"}'
   ```
4. **Rate limiting**: 4th request from same IP within 1 hour returns 429

Build check:
- `pnpm build` succeeds with no type errors
- API route is accessible at /api/waitlist
- .env.local has required env vars (with placeholder values for build)
</verification>

<success_criteria>
- POST /api/waitlist validates email, rate-limits by IP, creates Resend contact, and sends branded welcome email
- GET /api/waitlist returns subscriber count for the waitlist counter
- Rate limiting prevents abuse (3 requests per IP per hour)
- Welcome email is dark, minimal, philosophical — matches Momentum brand
- Duplicate signups handled gracefully
- All errors return appropriate HTTP status codes with user-friendly messages
- `pnpm build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-hero-conversion/02-02-SUMMARY.md`
</output>
